<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ValidMind â€“ validmind_insurance_poc</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../validmind.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../guide/ValidMind-logo-color.svg" alt="" class="navbar-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../guide/get-started.html">
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guide/guide.html">
 <span class="menu-text">Guides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guide/developer-framework.html">
 <span class="menu-text">Developer Framework</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guide/faq.html">
 <span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guide/support.html">
 <span class="menu-text">Support</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link" data-scroll-target="#executive-summary">Executive Summary</a></li>
  <li><a href="#overview-of-mortality-case-study" id="toc-overview-of-mortality-case-study" class="nav-link" data-scroll-target="#overview-of-mortality-case-study">Overview of Mortality Case Study</a></li>
  </ul></li>
  <li><a href="#set-up" id="toc-set-up" class="nav-link" data-scroll-target="#set-up">Set Up</a></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a></li>
  <li><a href="#modeling" id="toc-modeling" class="nav-link" data-scroll-target="#modeling">Modeling</a>
  <ul class="collapse">
  <li><a href="#traintest-split" id="toc-traintest-split" class="nav-link" data-scroll-target="#traintest-split">Train/test split</a></li>
  <li><a href="#glm-modeling-101" id="toc-glm-modeling-101" class="nav-link" data-scroll-target="#glm-modeling-101">GLM modeling 101</a></li>
  <li><a href="#model-1-poisson-distribution-with-log-link-on-count" id="toc-model-1-poisson-distribution-with-log-link-on-count" class="nav-link" data-scroll-target="#model-1-poisson-distribution-with-log-link-on-count">Model 1: Poisson distribution with log link on count</a></li>
  </ul></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation">Validation</a>
  <ul class="collapse">
  <li><a href="#goodness-of-fit" id="toc-goodness-of-fit" class="nav-link" data-scroll-target="#goodness-of-fit">1. Goodness of Fit</a></li>
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">2. Feature importance</a></li>
  <li><a href="#main-effects" id="toc-main-effects" class="nav-link" data-scroll-target="#main-effects">3. Main Effects</a></li>
  <li><a href="#interaction-effects" id="toc-interaction-effects" class="nav-link" data-scroll-target="#interaction-effects">4. Interaction Effects</a></li>
  <li><a href="#correlated-features" id="toc-correlated-features" class="nav-link" data-scroll-target="#correlated-features">5. Correlated Features</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul class="collapse">
  <li><a href="#model-1-not-using-formula" id="toc-model-1-not-using-formula" class="nav-link" data-scroll-target="#model-1-not-using-formula">Model 1 not using formula</a></li>
  <li><a href="#model-3-gaussian-distribution-with-log-link-on-mortality-rate" id="toc-model-3-gaussian-distribution-with-log-link-on-mortality-rate" class="nav-link" data-scroll-target="#model-3-gaussian-distribution-with-log-link-on-mortality-rate">Model 3: Gaussian distribution with log link on mortality rate</a></li>
  <li><a href="#model-4-xgboost" id="toc-model-4-xgboost" class="nav-link" data-scroll-target="#model-4-xgboost">Model 4: XGBoost</a></li>
  <li><a href="#compare-model-1-model-2-and-model-4" id="toc-compare-model-1-model-2-and-model-4" class="nav-link" data-scroll-target="#compare-model-1-model-2-and-model-4">Compare Model 1, Model 2 and Model 4</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/validmind/documentation/blob/main/site/notebooks/insurance_mortality/validmind_insurance_POC.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/validmind/documentation/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="executive-summary" class="level3">
<h3 class="anchored" data-anchor-id="executive-summary">Executive Summary</h3>
<p>Being able to make accurate and timely estimates of future claims is a fundamental task for actuaries. Questions of profitability, product competitiveness, and insurer solvency depend on understanding future claims, with mortality being one of the central issues facing a life insurer.</p>
<p>In this demo, we show an example of a machine learning application on mortality assumption setting, a classic life insurance problem. Using real mortality data collected by the Society of Actuaries, we will walk you through the process of model building and validation.</p>
</section>
<section id="overview-of-mortality-case-study" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-mortality-case-study">Overview of Mortality Case Study</h3>
<section id="case-study-data" class="level4">
<h4 class="anchored" data-anchor-id="case-study-data"><i> Case Study Data </i></h4>
<p>Our dataset is the composite mortality experience data at policy level from 2012 to 2016. This dataset is used to published the 2016 Individual Life Experience Report by SOAâ€™s Individual Life Experience Committee (ILEC).</p>
<p>For the case study, the data was restricted to term life insurance policies that were within the initial policy term, issued after 1980, and the issue age was at least 18 years old.</p>
<p>More details on this dataset can be found in Section 2 of the data report https://www.soa.org/49957f/globalassets/assets/files/resources/research-report/2021/2016-individual-life-report.pdf</p>
</section>
<section id="case-study-model" class="level4">
<h4 class="anchored" data-anchor-id="case-study-model"><i> Case Study Model </i></h4>
<p>For the case study in this paper, we used the <code>statsmodel</code>â€™s implementation of the GLM family models. Our main model is using Poisson distribution with log link function that is often used for mortality prediction.</p>
<p>The <b> response variable</b> used in this case study is the <code>number of deaths</code>. <code>Policies exposed</code> was used as a weight in the model. We also tried to fit the <code>mortality rate</code>, which is <code>number of deaths</code>/ <code>policies exposed</code> using Gaussian distribution with log link, that can be found in the Appendix</p>
<p>The <b>features</b> used in the mortality model are:</p>
<ul>
<li><p><code>Attained Age</code> â€“ the sum of the policyholderâ€™s age at policy issue and the number of years they have held the policy.</p></li>
<li><p><code>Duration</code> â€“ the number of years (starting with a value of one) the policyholder has had the policy.</p></li>
<li><p><code>Smoking Status</code> â€“ if the policyholder is considered a smoker or not.</p></li>
<li><p><code>Preferred Class</code> â€“ an underwriting structure used by insurers to classify and price policyholders. Different companies have different structures with the number of classes ranging from two to four. The lower the class designation, the healthier the policyholders who are put into that class. Thus, someone in class 1 of 3 (displayed as 1_3 in this paper) is considered healthier at time of issue than someone in class 3 of 3.</p></li>
<li><p><code>Gender</code> â€“ A categorical feature in the model with two levels, male and female.</p></li>
<li><p><code>Guaranteed Term Period</code> â€“ the length of the policy at issue during which the premium will remain constant regardless of policyholder behavior or health status. The shortest term period in the data is five years with increasing lengths by five years up to 30 years. Term period is used as a categorical feature with six levels.</p></li>
<li><p><code>Face_Amount_Band</code></p></li>
<li><p><code>Observation Year</code></p></li>
</ul>
</section>
</section>
</section>
<section id="set-up" class="level1">
<h1>Set Up</h1>
<div class="cell" hidden="true" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> preprocessing</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, letâ€™s download data directly from the SOA website and unzip. This might take 5-10 minutes due to the large size of the file.</p>
<div class="cell" hidden="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># directly curl from the SOA website and unzip</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> echo Working Directory <span class="op">=</span> $(pwd)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> <span class="cf">if</span> [ <span class="op">-</span>d <span class="st">"./Data"</span> ]<span class="op">;</span> then echo <span class="st">"Data folder already exists"</span><span class="op">;</span> <span class="cf">else</span> echo <span class="st">"Create Data folder"</span><span class="op">;</span> mkdir Data<span class="op">;</span> fi</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> <span class="cf">if</span> [ <span class="op">-</span>f <span class="st">"./Data/ILEC 2009-16 20200123.csv"</span> ]<span class="op">;</span> then echo <span class="st">"File already exists"</span><span class="op">;</span>  <span class="cf">else</span> echo <span class="st">"Download data .."</span><span class="op">;</span> curl https:<span class="op">//</span>cdn<span class="op">-</span>files.soa.org<span class="op">/</span>web<span class="op">/</span>ilec<span class="op">-</span><span class="dv">2016</span><span class="op">/</span>ilec<span class="op">-</span>data<span class="op">-</span><span class="bu">set</span>.<span class="bu">zip</span> <span class="op">--</span>output .<span class="op">/</span>Data<span class="op">/</span>ilec<span class="op">-</span>data<span class="op">-</span><span class="bu">set</span>.<span class="bu">zip</span><span class="op">;</span> echo <span class="st">"Unzip data .."</span><span class="op">;</span>  unzip .<span class="op">/</span>Data<span class="op">/</span>ilec<span class="op">-</span>data<span class="op">-</span><span class="bu">set</span>.<span class="bu">zip</span> <span class="op">-</span>d .<span class="op">/</span>Data<span class="op">;</span>  fi</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> echo <span class="st">"Done"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Working Directory = /Users/andres/code/validmind-sdk/notebooks/insurance_mortality
Data folder already exists
File already exists
Done</code></pre>
</div>
</div>
<p>Second, sample 5% from the giant file. Another 10 minutes or so the first time you run it :)</p>
<div class="cell" hidden="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sample 5% and save it out to a sample file</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'./Data/ILEC 2009-16 20200123 sample.csv'</span>):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    random.seed(<span class="dv">42</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    sample <span class="op">=</span> pd.read_csv(<span class="st">'./Data/ILEC 2009-16 20200123.csv'</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                        skiprows <span class="op">=</span> <span class="kw">lambda</span> i: i<span class="op">&gt;</span><span class="dv">0</span> <span class="kw">and</span> random.random() <span class="op">&gt;</span>p)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    sample.to_csv(<span class="st">'./Data/ILEC 2009-16 20200123 sample.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="eda" class="level1">
<h1>EDA</h1>
<div class="cell" hidden="true" data-scrolled="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load sample file </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> pd.read_csv(<span class="st">'./Data/ILEC 2009-16 20200123 sample.csv'</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                    usecols <span class="op">=</span> [<span class="st">'Observation_Year'</span>, <span class="st">'Gender'</span>, <span class="st">'Smoker_Status'</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'Insurance_Plan'</span>,  <span class="st">'Duration'</span>, <span class="st">'Attained_Age'</span>, <span class="st">'SOA_Guaranteed_Level_Term_Period'</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'Face_Amount_Band'</span>, <span class="st">'Preferred_Class'</span>, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'Number_Of_Deaths'</span>,<span class="st">'Policies_Exposed'</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'SOA_Anticipated_Level_Term_Period'</span>,<span class="st">'SOA_Post_level_Term_Indicator'</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'Expected_Death_QX2015VBT_by_Policy'</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                               <span class="st">'Issue_Age'</span>, <span class="st">'Issue_Year'</span>])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># target variable</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>sample_df[<span class="st">'mort'</span>] <span class="op">=</span> sample_df[<span class="st">'Number_Of_Deaths'</span>] <span class="op">/</span> sample_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>sample_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Observation_Year</th>
      <th>Gender</th>
      <th>Smoker_Status</th>
      <th>Insurance_Plan</th>
      <th>Issue_Age</th>
      <th>Duration</th>
      <th>Attained_Age</th>
      <th>Face_Amount_Band</th>
      <th>Issue_Year</th>
      <th>Preferred_Class</th>
      <th>SOA_Anticipated_Level_Term_Period</th>
      <th>SOA_Guaranteed_Level_Term_Period</th>
      <th>SOA_Post_level_Term_Indicator</th>
      <th>Number_Of_Deaths</th>
      <th>Policies_Exposed</th>
      <th>Expected_Death_QX2015VBT_by_Policy</th>
      <th>mort</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2009</td>
      <td>Female</td>
      <td>NonSmoker</td>
      <td>Perm</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>10000-24999</td>
      <td>2008</td>
      <td>NaN</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>0</td>
      <td>4.882191</td>
      <td>0.001074</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2009</td>
      <td>Female</td>
      <td>NonSmoker</td>
      <td>Perm</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>500000-999999</td>
      <td>2008</td>
      <td>NaN</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>0</td>
      <td>25.795943</td>
      <td>0.006449</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>Female</td>
      <td>NonSmoker</td>
      <td>Perm</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>10000-24999</td>
      <td>2008</td>
      <td>NaN</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>0</td>
      <td>1.117809</td>
      <td>0.000134</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2009</td>
      <td>Female</td>
      <td>NonSmoker</td>
      <td>Perm</td>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>250000-499999</td>
      <td>2008</td>
      <td>NaN</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>0</td>
      <td>70.098636</td>
      <td>0.009814</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2009</td>
      <td>Female</td>
      <td>NonSmoker</td>
      <td>Perm</td>
      <td>0</td>
      <td>4</td>
      <td>3</td>
      <td>50000-99999</td>
      <td>2006</td>
      <td>NaN</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>N/A (Not Term)</td>
      <td>0</td>
      <td>493.523281</td>
      <td>0.034547</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" hidden="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter pipeline</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> sample_df[(sample_df.Expected_Death_QX2015VBT_by_Policy <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.Smoker_Status <span class="op">!=</span> <span class="st">'Unknown'</span>) </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.Insurance_Plan <span class="op">==</span> <span class="st">' Term'</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (<span class="op">-</span>sample_df.Preferred_Class.isna())</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.Attained_Age <span class="op">&gt;=</span> <span class="dv">18</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.Issue_Year <span class="op">&gt;=</span> <span class="dv">1980</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.SOA_Post_level_Term_Indicator <span class="op">==</span> <span class="st">"Within Level Term"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.SOA_Anticipated_Level_Term_Period <span class="op">!=</span> <span class="st">"Unknown"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;</span> (sample_df.mort <span class="op">&lt;</span> <span class="dv">1</span>)]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Count: </span><span class="sc">{</span>sample_df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># describe data</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>sample_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Count: 307233
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Observation_Year</th>
      <th>Issue_Age</th>
      <th>Duration</th>
      <th>Attained_Age</th>
      <th>Issue_Year</th>
      <th>Preferred_Class</th>
      <th>Number_Of_Deaths</th>
      <th>Policies_Exposed</th>
      <th>Expected_Death_QX2015VBT_by_Policy</th>
      <th>mort</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>307233.000000</td>
      <td>3.072330e+05</td>
      <td>307233.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2014.084001</td>
      <td>42.248505</td>
      <td>7.951434</td>
      <td>49.199939</td>
      <td>2006.640537</td>
      <td>2.035013</td>
      <td>0.018514</td>
      <td>12.504679</td>
      <td>1.932158e-02</td>
      <td>0.001627</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.413654</td>
      <td>12.777574</td>
      <td>4.793230</td>
      <td>13.340539</td>
      <td>4.888334</td>
      <td>0.962332</td>
      <td>0.147063</td>
      <td>29.112019</td>
      <td>5.412559e-02</td>
      <td>0.023061</td>
    </tr>
    <tr>
      <th>min</th>
      <td>2012.000000</td>
      <td>18.000000</td>
      <td>1.000000</td>
      <td>18.000000</td>
      <td>1984.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.002732</td>
      <td>1.918000e-07</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2013.000000</td>
      <td>32.000000</td>
      <td>4.000000</td>
      <td>39.000000</td>
      <td>2003.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.838356</td>
      <td>7.766577e-04</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2014.000000</td>
      <td>42.000000</td>
      <td>7.000000</td>
      <td>49.000000</td>
      <td>2007.000000</td>
      <td>2.000000</td>
      <td>0.000000</td>
      <td>2.612022</td>
      <td>3.316641e-03</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2015.000000</td>
      <td>52.000000</td>
      <td>12.000000</td>
      <td>59.000000</td>
      <td>2011.000000</td>
      <td>3.000000</td>
      <td>0.000000</td>
      <td>10.680379</td>
      <td>1.470165e-02</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2016.000000</td>
      <td>84.000000</td>
      <td>30.000000</td>
      <td>91.000000</td>
      <td>2016.000000</td>
      <td>4.000000</td>
      <td>6.000000</td>
      <td>655.938021</td>
      <td>2.827005e+00</td>
      <td>0.981233</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" hidden="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode categorical variables</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="op">=</span> [<span class="st">'Observation_Year'</span>, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Gender'</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Smoker_Status'</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Face_Amount_Band'</span>, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Preferred_Class'</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>     <span class="st">'SOA_Anticipated_Level_Term_Period'</span>]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>onehot <span class="op">=</span> preprocessing.OneHotEncoder()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> onehot.fit_transform(sample_df[cat_vars]).toarray()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>cat_vars_encoded <span class="op">=</span> <span class="bu">list</span>(onehot.get_feature_names_out())</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> pd.concat([sample_df,pd.DataFrame(data <span class="op">=</span> results, columns <span class="op">=</span> cat_vars_encoded, index <span class="op">=</span> sample_df.index)], axis <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" hidden="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># categorical variables</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>face_amount_order <span class="op">=</span> [<span class="st">'    1-9999'</span>, <span class="st">'   10000-24999'</span>, <span class="st">'   25000-49999'</span>, <span class="st">'   50000-99999'</span>,<span class="st">'  100000-249999'</span> , <span class="st">'  250000-499999'</span>,<span class="st">'  500000-999999'</span>,<span class="st">' 1000000-2499999'</span>, <span class="st">' 2500000-4999999'</span>,<span class="st">' 5000000-9999999'</span>, <span class="st">'10000000+'</span>]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>term_period_order <span class="op">=</span> [<span class="st">' 5 yr guaranteed'</span>, <span class="st">'10 yr guaranteed'</span>,  <span class="st">'15 yr guaranteed'</span>, <span class="st">'20 yr guaranteed'</span>, <span class="st">'25 yr guaranteed'</span>,<span class="st">'30 yr guaranteed'</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">4</span>,<span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">20</span>,<span class="dv">30</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> ax.flatten()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,column <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'Observation_Year'</span>, <span class="st">'Gender'</span>, <span class="st">'Smoker_Status'</span>, <span class="st">'Insurance_Plan'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">'Face_Amount_Band'</span>, <span class="st">'Preferred_Class'</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>       <span class="st">'SOA_Guaranteed_Level_Term_Period'</span>]):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="op">==</span> <span class="st">'Face_Amount_Band'</span>:</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> face_amount_order</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> column <span class="op">==</span> <span class="st">'SOA_Guaranteed_Level_Term_Period'</span>:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> term_period_order</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    sns.countplot(y <span class="op">=</span> sample_df[column], ax <span class="op">=</span> ax[i], orient <span class="op">=</span> <span class="st">'h'</span>, order <span class="op">=</span> order)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" hidden="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># age and duration variables</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">20</span>,<span class="dv">5</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(x <span class="op">=</span> sample_df[<span class="st">'Attained_Age'</span>], ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sns.histplot(x <span class="op">=</span> sample_df[<span class="st">'Duration'</span>], ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" hidden="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we quickly check for any collinearity</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">20</span>,<span class="dv">20</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sns.heatmap(sample_df[[<span class="st">'Gender_Female'</span>,<span class="st">'Gender_Male'</span>,<span class="st">'Smoker_Status_NonSmoker'</span>,<span class="st">'Smoker_Status_Smoker'</span>,<span class="st">'Preferred_Class_1.0'</span>,<span class="st">'Preferred_Class_2.0'</span>,<span class="st">'Preferred_Class_3.0'</span>,<span class="st">'Preferred_Class_4.0'</span>,<span class="st">'Attained_Age'</span>, <span class="st">'Duration'</span>, <span class="st">'Policies_Exposed'</span>]].corr(), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" hidden="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># log mort by Attained Age</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stratify(field):</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> sample_df.groupby([<span class="st">'Attained_Age'</span>, field])[[<span class="st">'Number_Of_Deaths'</span>, <span class="st">'Policies_Exposed'</span>]].<span class="bu">sum</span>().reset_index()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    temp[<span class="st">'log_mort'</span>] <span class="op">=</span> (temp.Number_Of_Deaths <span class="op">/</span> temp.Policies_Exposed).<span class="bu">apply</span>(np.log)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(data <span class="op">=</span> temp, x <span class="op">=</span> <span class="st">'Attained_Age'</span>, y <span class="op">=</span> <span class="st">'log_mort'</span>, hue <span class="op">=</span> field, ax <span class="op">=</span> ax)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Log Mortality Rate by Attained Age and </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>stratify(<span class="st">'Smoker_Status'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>stratify(<span class="st">'Preferred_Class'</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>stratify(<span class="st">'Gender'</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>stratify(<span class="st">'Observation_Year'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-11-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="validmind_insurance_POC_files/figure-html/cell-11-output-4.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="modeling" class="level1">
<h1>Modeling</h1>
<section id="traintest-split" class="level3">
<h3 class="anchored" data-anchor-id="traintest-split">Train/test split</h3>
<p>First we split the data into 80% for training and 20% for testing.</p>
<p>In this context because we donâ€™t really need to do hyperparameter tuning so itâ€™s not necessary to create a validation set.</p>
<div class="cell" hidden="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create training (80%), validation (5%) and test set (15%)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>random_seed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> sample_df.sample(frac <span class="op">=</span> <span class="fl">0.8</span>, random_state <span class="op">=</span> random_seed)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> sample_df.loc[<span class="op">~</span>sample_df.index.isin(train_df.index),:]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add constant variable</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'Const'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Const'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Train size: </span><span class="sc">{</span>train_df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, test size: </span><span class="sc">{</span>test_df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train size: 245786, test size: 61447</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>train_df.to_csv(<span class="st">'train_df.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>test_df.to_csv(<span class="st">'test_df.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="glm-modeling-101" class="level3">
<h3 class="anchored" data-anchor-id="glm-modeling-101">GLM modeling 101</h3>
<p>In a generalized linear model (GLM), each outcome Y of the dependent variables is assumed to be generated from a particular distribution in an exponential family, a large class of probability distributions that includes the normal, binomial, Poisson and gamma distributions, among others. The mean, <span class="math inline">\(Î¼\)</span>, of the distribution depends on the independent variables, X, through</p>
<center>
<span class="math inline">\({\displaystyle \operatorname {E} (\mathbf {Y} |\mathbf {X} )={\boldsymbol {\mu }}=g^{-1}(\mathbf {X} {\boldsymbol {\beta }})}\)</span>
</center>
<p><span class="math inline">\({\displaystyle \operatorname {E} (\mathbf {Y} |\mathbf {X} )={\boldsymbol {\mu }}=g^{-1}(\mathbf {X} {\boldsymbol {\beta }})}\)</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(E(Y|X)\)</span> is the expected value of <span class="math inline">\(Y\)</span> conditional on <span class="math inline">\(X\)</span></li>
<li><span class="math inline">\(XÎ²\)</span> is the linear predictor, a linear combination of unknown parameters <span class="math inline">\(Î²\)</span></li>
<li><span class="math inline">\(g\)</span> is the link function.</li>
</ul>
</section>
<section id="model-1-poisson-distribution-with-log-link-on-count" class="level3">
<h3 class="anchored" data-anchor-id="model-1-poisson-distribution-with-log-link-on-count">Model 1: Poisson distribution with log link on count</h3>
<p><i> Target Variable </i> = [Number_Of_Deaths]</p>
<p><i> Input Variables </i> = [Observation_Year, Gender, Smoker_Status, Face_Amount_Band, Preferred_Class, Attained_Age, Duration, SOA_Anticipated_Level_Term_Period]</p>
<p>As the <i> target variable</i> is a count measure, we will fit GLM with Poisson distribution and log link.</p>
<p>The target variable is count, what we really fit the Poisson model to is mortality rate (count/exposure) with the use of offset. This is a common practice according to https://en.wikipedia.org/wiki/Poisson_regression</p>
<div class="cell" hidden="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="op">=</span> smf.glm(formula <span class="op">=</span> <span class="st">'Number_Of_Deaths ~ 1 + C(Observation_Year)+ C(Gender) + C(Smoker_Status) + C(Face_Amount_Band) + C(Preferred_Class) + C(SOA_Anticipated_Level_Term_Period) </span><span class="ch">\</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="st">                                       + Attained_Age + Duration'</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> train_df,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                family<span class="op">=</span>sm.families.Poisson(sm.families.links.log()),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                freq_weights <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>res1 <span class="op">=</span> model1.fit()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>res1.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">

<table class="simpletable">
<caption>Generalized Linear Model Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>   <td>Number_Of_Deaths</td> <th>  No. Observations:  </th>   <td>245786</td>   
</tr>
<tr>
  <th>Model:</th>                  <td>GLM</td>       <th>  Df Residuals:      </th> <td>3076911.54</td> 
</tr>
<tr>
  <th>Model Family:</th>         <td>Poisson</td>     <th>  Df Model:          </th>   <td>    26</td>   
</tr>
<tr>
  <th>Link Function:</th>          <td>log</td>       <th>  Scale:             </th>  <td>  1.0000</td>  
</tr>
<tr>
  <th>Method:</th>                <td>IRLS</td>       <th>  Log-Likelihood:    </th> <td>-7.1471e+05</td>
</tr>
<tr>
  <th>Date:</th>            <td>Mon, 05 Dec 2022</td> <th>  Deviance:          </th> <td>9.8740e+05</td> 
</tr>
<tr>
  <th>Time:</th>                <td>22:28:25</td>     <th>  Pearson chi2:      </th>  <td>3.17e+06</td>  
</tr>
<tr>
  <th>No. Iterations:</th>         <td>24</td>        <th>  Pseudo R-squ. (CS):</th>   <td>0.6540</td>   
</tr>
<tr>
  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>                     </th>      <td> </td>     
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
                              <td></td>                                 <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P&gt;|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>                                                 <td>   -9.2794</td> <td>    0.158</td> <td>  -58.838</td> <td> 0.000</td> <td>   -9.589</td> <td>   -8.970</td>
</tr>
<tr>
  <th>C(Observation_Year)[T.2013]</th>                               <td>   -0.0545</td> <td>    0.007</td> <td>   -8.190</td> <td> 0.000</td> <td>   -0.067</td> <td>   -0.041</td>
</tr>
<tr>
  <th>C(Observation_Year)[T.2014]</th>                               <td>   -0.0051</td> <td>    0.006</td> <td>   -0.789</td> <td> 0.430</td> <td>   -0.018</td> <td>    0.008</td>
</tr>
<tr>
  <th>C(Observation_Year)[T.2015]</th>                               <td>   -0.1405</td> <td>    0.007</td> <td>  -20.705</td> <td> 0.000</td> <td>   -0.154</td> <td>   -0.127</td>
</tr>
<tr>
  <th>C(Observation_Year)[T.2016]</th>                               <td>   -0.0813</td> <td>    0.007</td> <td>  -12.377</td> <td> 0.000</td> <td>   -0.094</td> <td>   -0.068</td>
</tr>
<tr>
  <th>C(Gender)[T.Male]</th>                                         <td>    0.3527</td> <td>    0.005</td> <td>   74.784</td> <td> 0.000</td> <td>    0.343</td> <td>    0.362</td>
</tr>
<tr>
  <th>C(Smoker_Status)[T.Smoker]</th>                                <td>    1.0350</td> <td>    0.015</td> <td>   67.166</td> <td> 0.000</td> <td>    1.005</td> <td>    1.065</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.   10000-24999]</th>                     <td>   -0.7187</td> <td>    0.118</td> <td>   -6.104</td> <td> 0.000</td> <td>   -0.949</td> <td>   -0.488</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.   25000-49999]</th>                     <td>   -0.7632</td> <td>    0.117</td> <td>   -6.500</td> <td> 0.000</td> <td>   -0.993</td> <td>   -0.533</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.   50000-99999]</th>                     <td>   -0.9776</td> <td>    0.117</td> <td>   -8.372</td> <td> 0.000</td> <td>   -1.206</td> <td>   -0.749</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.  100000-249999]</th>                    <td>   -1.6819</td> <td>    0.116</td> <td>  -14.452</td> <td> 0.000</td> <td>   -1.910</td> <td>   -1.454</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.  250000-499999]</th>                    <td>   -2.0061</td> <td>    0.116</td> <td>  -17.222</td> <td> 0.000</td> <td>   -2.234</td> <td>   -1.778</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.  500000-999999]</th>                    <td>   -2.0428</td> <td>    0.117</td> <td>  -17.521</td> <td> 0.000</td> <td>   -2.271</td> <td>   -1.814</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T. 1000000-2499999]</th>                   <td>   -2.0690</td> <td>    0.117</td> <td>  -17.721</td> <td> 0.000</td> <td>   -2.298</td> <td>   -1.840</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T. 2500000-4999999]</th>                   <td>   -2.0173</td> <td>    0.138</td> <td>  -14.656</td> <td> 0.000</td> <td>   -2.287</td> <td>   -1.747</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T. 5000000-9999999]</th>                   <td>   -2.0177</td> <td>    0.229</td> <td>   -8.795</td> <td> 0.000</td> <td>   -2.467</td> <td>   -1.568</td>
</tr>
<tr>
  <th>C(Face_Amount_Band)[T.10000000+]</th>                          <td>  -23.7738</td> <td> 1.48e+04</td> <td>   -0.002</td> <td> 0.999</td> <td>-2.89e+04</td> <td> 2.89e+04</td>
</tr>
<tr>
  <th>C(Preferred_Class)[T.2.0]</th>                                 <td>    0.4593</td> <td>    0.005</td> <td>   94.004</td> <td> 0.000</td> <td>    0.450</td> <td>    0.469</td>
</tr>
<tr>
  <th>C(Preferred_Class)[T.3.0]</th>                                 <td>    0.4168</td> <td>    0.007</td> <td>   60.272</td> <td> 0.000</td> <td>    0.403</td> <td>    0.430</td>
</tr>
<tr>
  <th>C(Preferred_Class)[T.4.0]</th>                                 <td>    0.5337</td> <td>    0.011</td> <td>   48.013</td> <td> 0.000</td> <td>    0.512</td> <td>    0.555</td>
</tr>
<tr>
  <th>C(SOA_Anticipated_Level_Term_Period)[T.10 yr anticipated]</th> <td>   -0.1692</td> <td>    0.105</td> <td>   -1.607</td> <td> 0.108</td> <td>   -0.376</td> <td>    0.037</td>
</tr>
<tr>
  <th>C(SOA_Anticipated_Level_Term_Period)[T.15 yr anticipated]</th> <td>   -0.2569</td> <td>    0.105</td> <td>   -2.438</td> <td> 0.015</td> <td>   -0.463</td> <td>   -0.050</td>
</tr>
<tr>
  <th>C(SOA_Anticipated_Level_Term_Period)[T.20 yr anticipated]</th> <td>   -0.4042</td> <td>    0.105</td> <td>   -3.844</td> <td> 0.000</td> <td>   -0.610</td> <td>   -0.198</td>
</tr>
<tr>
  <th>C(SOA_Anticipated_Level_Term_Period)[T.25 yr anticipated]</th> <td>    0.0217</td> <td>    0.106</td> <td>    0.205</td> <td> 0.838</td> <td>   -0.186</td> <td>    0.229</td>
</tr>
<tr>
  <th>C(SOA_Anticipated_Level_Term_Period)[T.30 yr anticipated]</th> <td>   -0.2437</td> <td>    0.105</td> <td>   -2.314</td> <td> 0.021</td> <td>   -0.450</td> <td>   -0.037</td>
</tr>
<tr>
  <th>Attained_Age</th>                                              <td>    0.0739</td> <td>    0.000</td> <td>  254.173</td> <td> 0.000</td> <td>    0.073</td> <td>    0.075</td>
</tr>
<tr>
  <th>Duration</th>                                                  <td>    0.0497</td> <td>    0.001</td> <td>   92.131</td> <td> 0.000</td> <td>    0.049</td> <td>    0.051</td>
</tr>
</tbody></table>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>res1.predict(exog <span class="op">=</span> train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>1283609    0.000487
914790     0.000164
1468496    0.004144
1515604    0.000442
1073383    0.001613
             ...   
1313854    0.010491
1004151    0.000598
1354488    0.000129
1040410    0.001310
1226199    0.000978
Length: 245786, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>res1.save(<span class="st">'res1.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>res1.predict(exog <span class="op">=</span> train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>1283609    0.000487
914790     0.000164
1468496    0.004144
1515604    0.000442
1073383    0.001613
             ...   
1313854    0.010491
1004151    0.000598
1354488    0.000129
1040410    0.001310
1226199    0.000978
Length: 245786, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>loaded <span class="op">=</span> sm.load(<span class="st">'res1.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> loaded.model.fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fitted.predict(train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>1283609    0.000487
914790     0.000164
1468496    0.004144
1515604    0.000442
1073383    0.001613
             ...   
1313854    0.010491
1004151    0.000598
1354488    0.000129
1040410    0.001310
1226199    0.000978
Length: 245786, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fitted.params[<span class="st">"Intercept"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>-9.279412567322963</code></pre>
</div>
</div>
<p>First, we show the <b>lift chart</b> that breaks down the predicted mortality rates into deciles and show how the actual compares against the predicted rates for each decile. Looks like the predicted are not too far off on the test set, but then weâ€™re only look at the high-level average for each decile.</p>
<div class="cell" hidden="true" data-scrolled="true">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># append fitted values for training and predicted values for testing</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'mort_hat1'</span>] <span class="op">=</span> res1.predict(exog <span class="op">=</span> train_df)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'death_hat1'</span>] <span class="op">=</span> train_df[<span class="st">'mort_hat1'</span>] <span class="op">*</span> train_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'mort_hat1'</span>] <span class="op">=</span> res1.predict(exog <span class="op">=</span> test_df)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'death_hat1'</span>] <span class="op">=</span> test_df[<span class="st">'mort_hat1'</span>] <span class="op">*</span> test_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># groupby and aggregate by deciles</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'deciles'</span>] <span class="op">=</span> pd.qcut(test_df[<span class="st">'mort_hat1'</span>], <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>wm <span class="op">=</span> <span class="kw">lambda</span> x: np.average(x, weights<span class="op">=</span>test_df.loc[x.index, <span class="st">"Policies_Exposed"</span>])</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> test_df.groupby([<span class="st">"deciles"</span>]).agg(actual<span class="op">=</span>(<span class="st">"mort_hat1"</span>, wm), predicted <span class="op">=</span> (<span class="st">'mort'</span>, wm))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>temp</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># lift chart </span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>temp.plot(ax <span class="op">=</span> ax)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Actual vs predicted mortality rate by deciles'</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, we can plot the partial dependency chart between the <code>log mortality rate</code> and key covariates like <code>Attained Age</code> or <code>Duration</code> to see more granular comparisons between actual vs predicted.</p>
<p>We can immediately see that even on the train set, the model does not capture the dynamics near the two tails of the age distribution very well.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pdp(df, agg_field, title, predict_col <span class="op">=</span> <span class="st">'death_hat1'</span>):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> df.groupby(agg_field)[<span class="st">'Number_Of_Deaths'</span>, predict_col, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'log_mort'</span>] <span class="op">=</span> (agg[<span class="st">'Number_Of_Deaths'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]).<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'log_mort_predicted'</span>] <span class="op">=</span> (agg[predict_col]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]).<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    ax.plot(agg[agg_field], agg[<span class="st">'log_mort'</span>], color <span class="op">=</span> <span class="st">'r'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(agg[agg_field], agg[<span class="st">'log_mort_predicted'</span>], color <span class="op">=</span> <span class="st">'b'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    plt.legend([<span class="st">'actual'</span>,<span class="st">'predicted'</span>]) </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(agg_field)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'log_mort'</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>pdp(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'How well does the model fit the train set'</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>pdp(train_df, <span class="st">'Duration'</span>, <span class="st">'How well does the model fit the train set'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>pdp(test_df, <span class="st">'Attained_Age'</span>, <span class="st">'How well does the model fit the test set'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pdp(test_df, <span class="st">'Duration'</span>, <span class="st">'How well does the model fit the test set'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Third, we look at Prediction Error by taking the difference between the <code>Number Of Deaths</code> (actual) and Predicted Number of Deaths and then normalized by <code>Policies Exposed</code>. This tells the same story as the dependecy chart that we have a lot of errors near the two tails of the age distribution.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'Err1'</span>] <span class="op">=</span> (train_df[<span class="st">'death_hat1'</span>] <span class="op">-</span> train_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> train_df[<span class="st">'death_hat1'</span>]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> train_df.groupby(<span class="st">'Attained_Age'</span>)[<span class="st">'Err1'</span>, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err1'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Model 1'</span>])</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Error'</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Training Error'</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Err1'</span>] <span class="op">=</span> (test_df[<span class="st">'death_hat1'</span>] <span class="op">-</span> test_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> test_df[<span class="st">'death_hat1'</span>]</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> test_df.groupby(<span class="st">'Attained_Age'</span>)[<span class="st">'Err1'</span>, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err1'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]))</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Model 1'</span>])</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Error'</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Testing error'</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="validation" class="level1">
<h1>Validation</h1>
<section id="goodness-of-fit" class="level3">
<h3 class="anchored" data-anchor-id="goodness-of-fit">1. Goodness of Fit</h3>
<section id="pseudo-r-squared" class="level4">
<h4 class="anchored" data-anchor-id="pseudo-r-squared"><i> Pseudo R-squared </i></h4>
<p>In linear regression, the squared multiple correlation, R-squared is often used to assess goodness of fit as it represents the proportion of variance in the criterion that is explained by the predictors.</p>
<p>For GLM, pseudo R-squared is the most analogous measure to the squared multiple correlations. It represents the proportional reduction in the deviance wherein the deviance is treated as a measure of variation analogous but not identical to the variance in linear regression analysis. Quantifiably, the higher is better.</p>
<center>
<span class="math inline">\(R_{\text{L}}^{2}={\frac {{Deviance}_{\text{null}}-Deviance_{\text{fitted}}}{Deviance_{\text{null}}}}\)</span>
</center>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>res1.pseudo_rsquared()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deviance" class="level4">
<h4 class="anchored" data-anchor-id="deviance"><i> Deviance </i></h4>
<p>The (total) deviance for a model M with estimates <span class="math inline">\({\displaystyle {\hat {\mu }}=E[Y|{\hat {\theta }}_{0}]}\)</span>, based on a dataset y, may be constructed by its likelihood as:</p>
<center>
<span class="math inline">\({\displaystyle D(y,{\hat {\mu }})=2\left(\log \left[p(y\mid {\hat {\theta }}_{s})\right]-\log \left[p(y\mid {\hat {\theta }}_{0})\right]\right)}\)</span>
</center>
<p>Here <span class="math inline">\(\hat \theta_0\)</span> denotes the fitted values of the parameters in the model M, while <span class="math inline">\(\hat \theta_s\)</span> denotes the fitted parameters for the saturated model: both sets of fitted values are implicitly functions of the observations y.</p>
<p>In large samples, deviance follows a chi-square distribution with nâˆ’p degrees of freedom, where n is the number of observations and p is the number of parameters in the model. The null hypothesis, H0, is that the model fits. The alternative hypothesis, H1, is that the model does not fit. A deviance much higher than nâˆ’p indicates the model is a poor fit to the data. Quantifiably, smaller is always better: The smaller the deviance, the better the fit of the model.</p>
<p>Here we divided the <code>deviance</code> by the <code>residual degree of freedom</code> and observed a ratio much smaller than 1</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>res1.deviance<span class="op">/</span>res1.df_resid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pearson-statistic-and-dispersion" class="level4">
<h4 class="anchored" data-anchor-id="pearson-statistic-and-dispersion"><i> Pearson Statistic and dispersion </i></h4>
<p>Similar to <code>deviance</code> test, the <code>Pearson Statistic</code> is approximately chi-square distributed with n â€“ p degrees of freedom. A Pearson Statistic much higher than the degree of freedom indicates that the model is a poor fit.</p>
<p>Additionally, for a Poisson distribution, the mean and the variance are equal. In addition to testing goodness-of-fit, the Pearson statistic can also be used as a test of overdispersion. <b>Overdispersion</b> means that the actual covariance matrix for the observed data exceeds that for the specified model for Y|X.</p>
<p>Here we divided the <code>pearson statistic</code> by the <code>residual degree of freedom</code> and observed a value very close to 1</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>res1.pearson_chi2<span class="op">/</span>res1.df_resid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="feature-importance">2. Feature importance</h3>
<section id="confidence-intervals-and-p-values" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-and-p-values"><i>Confidence intervals and p-values </i></h4>
<p>Confidence intervals and p-values quantifying the statistical significance of individual predictor variables. Unlike other models like XGBoost, the estimates for statistical significance of individual predictor variables are readily available.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>res1.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the summary, we can see that all of the features other than <code>SOA_Anticipated_Level_Term_Period</code> are significant as all p-values are &lt; 5%.</p>
<p>Directionally, the coeficients for the main features like <code>Gender</code>, <code>Smoking Status</code>, <code>Attained_Age</code> or <code>Duration</code> are all aligned with our intuition and the EDA charts that we created previously:</p>
<ul>
<li>Mortality rate for Male is higher than Female</li>
<li>Mortality rate for Smoker is higher than non-Smoker</li>
<li>Mortality rate is higher as age is higher</li>
<li>Mortality rate is higher as duration is longer</li>
</ul>
</section>
</section>
<section id="main-effects" class="level3">
<h3 class="anchored" data-anchor-id="main-effects">3. Main Effects</h3>
<p>We want to understand the individual effects for each feature in the model. In a GLM context, the coefficient value of each feature already made it easy to understand the direction, magnitude, and shape of a featureâ€™s effect on the predicted value. We can take this further by producing the partial dependence plots (PDP) that display partial dependencies of predicted mortality in terms of key covariates. Within each visualization, the projections are averaged over all covariates not included and over all predicted rows to provide an average representation of the full data set given.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pdp2(df, x, hue, predict_col <span class="op">=</span> <span class="st">'death_hat1'</span>):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> df.groupby([x, hue])[<span class="st">'Number_Of_Deaths'</span>, predict_col, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'log_mort_predicted'</span>] <span class="op">=</span> (agg[predict_col]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]).<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">6</span>,<span class="dv">3</span>))</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(data <span class="op">=</span> agg, x <span class="op">=</span> x, y <span class="op">=</span> <span class="st">'log_mort_predicted'</span>, hue <span class="op">=</span> hue, ax <span class="op">=</span> ax)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(x)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'log_mort'</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Log mortality by </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>hue<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Gender'</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Gender'</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Smoker_Status'</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Smoker_Status'</span>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Preferred_Class'</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Preferred_Class'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that the partial dependency plots reconfirms the directional relationships between important covariates and the output that we have discussed in part 2. Feature Importances</p>
<p>Additionally, the charts reflect that fact that we have not included any interactions between the covariates. Look at the difference in mortality between smoking and non-smokingm for example, itâ€™s almost constant regardless of ages.</p>
</section>
<section id="interaction-effects" class="level3">
<h3 class="anchored" data-anchor-id="interaction-effects">4. Interaction Effects</h3>
<p>One of the key elements in understanding a predictive model is examining its interaction effects. Interaction effects occur when the impact of a change in a variable depends on the values of other features.</p>
<p>Here we fit a model with all first-order interactions between variables and compare the results against our Vanilla model to evaluate the effect of interactions.</p>
<section id="model-2-poisson-distribution-with-log-link-on-death-count-with-interactions" class="level4">
<h4 class="anchored" data-anchor-id="model-2-poisson-distribution-with-log-link-on-death-count-with-interactions"><i> Model 2: Poisson distribution with log link on Death Count with interactions </i></h4>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="op">=</span> smf.glm(formula <span class="op">=</span> <span class="st">'Number_Of_Deaths ~ 1 + C(Observation_Year) + C(Gender) + C(Smoker_Status) + C(Face_Amount_Band) + C(Preferred_Class) +  Attained_Age + Duration</span><span class="ch">\</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="st">                        + C(Observation_Year) * (C(Gender) + C(Smoker_Status) + C(Face_Amount_Band) + C(Preferred_Class) + Attained_Age + Duration) + C(Gender) * (C(Smoker_Status) + C(Face_Amount_Band) + C(Preferred_Class) + Attained_Age + Duration) + C(Smoker_Status) * (C(Face_Amount_Band) + C(Preferred_Class) + Attained_Age + Duration) + C(Face_Amount_Band) * (C(Preferred_Class) + Attained_Age + Duration) + C(Preferred_Class) * (Attained_Age + Duration) + Attained_Age * Duration'</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> train_df,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                family<span class="op">=</span>sm.families.Poisson(sm.families.links.log()),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                freq_weights <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>],</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>res2 <span class="op">=</span> model2.fit() <span class="co">#_regularized(method='elastic_net', alpha=0.5)</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># append fitted values for training and predicted values for testing</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'mort_hat2'</span>] <span class="op">=</span> res2.predict(exog <span class="op">=</span> train_df)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'death_hat2'</span>] <span class="op">=</span> train_df[<span class="st">'mort_hat2'</span>] <span class="op">*</span> train_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'mort_hat2'</span>] <span class="op">=</span> res2.predict(exog <span class="op">=</span> test_df)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'death_hat2'</span>] <span class="op">=</span> test_df[<span class="st">'mort_hat2'</span>] <span class="op">*</span> test_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>res2.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compared-to-the-vanilla-model" class="level4">
<h4 class="anchored" data-anchor-id="compared-to-the-vanilla-model"><i> Compared to the vanilla model </i></h4>
<p>First, pearson and deviance are reasonable</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Pearson_statistics/df = </span><span class="sc">{</span>res2<span class="sc">.</span>pearson_chi2<span class="op">/</span>res2<span class="sc">.</span>df_resid<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'deviance/df = </span><span class="sc">{</span>res2<span class="sc">.</span>deviance<span class="op">/</span>res2<span class="sc">.</span>df_resid<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compared against model 1, we noticed a siginificant reduction on AIC so model 2 has a better fit, but the trade off is a more convoluted set of features.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'AIC for Model 1 - No interaction: </span><span class="sc">{</span>res1<span class="sc">.</span>aic<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'AIC for Model 2 - With interactions: </span><span class="sc">{</span>res2<span class="sc">.</span>aic<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><b>Side note on definition of AIC: </b> A collection of candidate models can be compared, and the selection criteria may be to choose the model with the highest log-likelihood. However, the log-likelihood of a model will almost always increase with the addition of more variables, even if those variables are insignificant and do little to increase the modelâ€™s predictive power. The Akaike information criterion, or AIC, is a penalized log-likelihood formula that charges a penalty for additional variables. It can be thought of as a measure of the relative quality of a model. When considering one or more models fit to the same dataset, the preferred model is the one with the minimum AIC value.</p>
</section>
</section>
<section id="correlated-features" class="level3">
<h3 class="anchored" data-anchor-id="correlated-features">5. Correlated Features</h3>
<p>For GLMs and other variations of linear models, correlation, multicollinearity, and aliasing (perfect correlation) among predictor variables can cause standard deviations of coefficients to be large and coefficients to behave erratically, causing issues with interpretability.</p>
<p>This is usually assessed by looking at the correlation matrix, which we have seen during the EDA phase. Letâ€™s show it again below. We donâ€™t see severe correlation between any two features that requires dropping one from the feature set.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we quickly check for any collinearity</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">20</span>,<span class="dv">20</span>))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>sns.heatmap(train_df[[<span class="st">'Gender_Female'</span>,<span class="st">'Gender_Male'</span>,<span class="st">'Smoker_Status_NonSmoker'</span>,<span class="st">'Smoker_Status_Smoker'</span>,<span class="st">'Preferred_Class_1.0'</span>,<span class="st">'Preferred_Class_2.0'</span>,<span class="st">'Preferred_Class_3.0'</span>,<span class="st">'Preferred_Class_4.0'</span>,<span class="st">'Attained_Age'</span>, <span class="st">'Duration'</span>, <span class="st">'Policies_Exposed'</span>, <span class="st">'Const'</span>]].corr(), annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In this notebook, we walked through the process of building a GLM model for mortality prediction and the important validation exercises to confirm the correctness of the model. - We performed EDA on the ILEC dataset and created a simple GLM model with Poisson distribution and log link and achieved reasonable goodness of fit even with only a handful number of covariates. - We validated and confirmed the soundness of the feature importance and main efferts of important covariates. - We checked for any necessary inclusion of interactions and handling of correlated features.</p>
<p>Apparently, we are still limited by linear combination of covariates at the core of the Poisson GLM model, so certain non-linear dynamics near the two tails of the age distribution are not captured very well. In the Appendix, we show an example of how a more complex model like GBM has the potential to better capture those dynamics.</p>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="model-1-not-using-formula" class="level3">
<h3 class="anchored" data-anchor-id="model-1-not-using-formula">Model 1 not using formula</h3>
<p>This is the explicit setup where we donâ€™t lean on R-like formula to set up the model. The output coefficients are in the same ballpark as model 1 using the formula in the main analysis.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Target Variable</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> [<span class="st">'Number_Of_Deaths'</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictors (aka Input Variables)</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cat_vars_encoded <span class="op">+</span> [<span class="st">'Attained_Age'</span>, <span class="st">'Duration'</span>,  <span class="st">'Const'</span>] </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Our choice for Link function is the Gaussian distribution for the nature of death frequency</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.GLM(endog <span class="op">=</span> train_df[Y], </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>               exog <span class="op">=</span> train_df[X], </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>               family<span class="op">=</span>sm.families.Poisson(sm.families.links.log()),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>               freq_weights <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>],</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>               offset <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.log(x))</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> model.fit()</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>res.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-3-gaussian-distribution-with-log-link-on-mortality-rate" class="level3">
<h3 class="anchored" data-anchor-id="model-3-gaussian-distribution-with-log-link-on-mortality-rate">Model 3: Gaussian distribution with log link on mortality rate</h3>
<p>This is an experiment where we try to fit a GLM with Gaussian distribution and log link to the mortality rate. <code>Pseudo R-squared</code> is far worse than Model 1</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="op">=</span> smf.glm(formula <span class="op">=</span> <span class="st">'mort ~ 1 + C(Observation_Year) + C(Gender) + C(Smoker_Status) + C(Face_Amount_Band) + C(Preferred_Class) + Attained_Age + Duration'</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                 data <span class="op">=</span> train_df,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                 family<span class="op">=</span>sm.families.Gaussian(link <span class="op">=</span> sm.families.links.log()),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                 freq_weights <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>])</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>res2 <span class="op">=</span> model2.fit()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>res2.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-4-xgboost" class="level3">
<h3 class="anchored" data-anchor-id="model-4-xgboost">Model 4: XGBoost</h3>
<p>In this experiment, we fit a Boosted Tree model to show how a more flexible can better fit the training data and generalize on test data.</p>
<p>Note that a more thorough model building process with cross validation and regularization would be needed to find the best hyperparameters for the XGBRegressor model, we will save that for another time.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> [<span class="st">'Observation_Year'</span>, <span class="st">'Gender'</span>, <span class="st">'Smoker_Status'</span>, <span class="st">'Face_Amount_Band'</span>, <span class="st">'Preferred_Class'</span>, <span class="st">'SOA_Anticipated_Level_Term_Period'</span>, <span class="st">'Attained_Age'</span>, <span class="st">'Duration'</span>]<span class="co">#, 'Policies_Exposed']</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> [<span class="st">'mort'</span>]<span class="co">#['Number_Of_Deaths']</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>X_cat <span class="op">=</span> [<span class="st">'Observation_Year'</span>, <span class="st">'Gender'</span>, <span class="st">'Smoker_Status'</span>, <span class="st">'Face_Amount_Band'</span>, <span class="st">'Preferred_Class'</span>, <span class="st">'SOA_Anticipated_Level_Term_Period'</span>]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> X_cat:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    train_df[x] <span class="op">=</span> train_df[x].astype(<span class="st">"category"</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    test_df[x] <span class="op">=</span> test_df[x].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create model instance</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>bst <span class="op">=</span> xgb.XGBRegressor(n_estimators<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                   max_depth<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                   learning_rate<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                   objective<span class="op">=</span><span class="st">'count:poisson'</span>, </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                   enable_categorical <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                   tree_method <span class="op">=</span> <span class="st">'approx'</span>, </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                   booster <span class="op">=</span> <span class="st">'gbtree'</span>, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                   verbosity <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>bst.fit(train_df[X], train_df[Y],sample_weight <span class="op">=</span> train_df[<span class="st">'Policies_Exposed'</span>])</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co"># make predictions</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> bst.predict(test_df[X])</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># append fitted values for training and predicted values for testing</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'mort_hat4'</span>] <span class="op">=</span> bst.predict(train_df[X])</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'death_hat4'</span>] <span class="op">=</span> train_df[<span class="st">'mort_hat4'</span>] <span class="op">*</span> train_df[<span class="st">'Policies_Exposed'</span>]</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'mort_hat4'</span>] <span class="op">=</span> bst.predict(test_df[X])</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'death_hat4'</span>] <span class="op">=</span> test_df[<span class="st">'mort_hat4'</span>] <span class="op">*</span> test_df[<span class="st">'Policies_Exposed'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lift chart does not show too much of a difference from Model 1</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lift chart by deciles</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'deciles'</span>] <span class="op">=</span> pd.qcut(test_df[<span class="st">'mort_hat4'</span>], <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>wm <span class="op">=</span> <span class="kw">lambda</span> x: np.average(x, weights<span class="op">=</span>test_df.loc[x.index, <span class="st">"Policies_Exposed"</span>])</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># groupby and aggregate</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> test_df.groupby([<span class="st">"deciles"</span>]).agg(actual<span class="op">=</span>(<span class="st">"mort_hat4"</span>, wm), predicted <span class="op">=</span> (<span class="st">'mort'</span>, wm))</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>temp.plot(ax <span class="op">=</span> ax)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Actual vs Predicted by deciles'</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting actual vs predicted by age shows tighter fit on the training set, and the model seems to be able to capture the dynamics near the two tails of the age distribution better.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># partial dependence plots</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>pdp(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Actual vs Predicted by Attained_Age - Training'</span>, <span class="st">'death_hat4'</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>pdp(train_df, <span class="st">'Duration'</span>, <span class="st">'Actual vs Predicted by Duration - Training'</span>, <span class="st">'death_hat4'</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>pdp(test_df, <span class="st">'Attained_Age'</span>, <span class="st">'Actual vs Predicted by Attained_Age - Testing'</span>, <span class="st">'death_hat4'</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>pdp(test_df, <span class="st">'Duration'</span>, <span class="st">'Actual vs Predicted by Duration - Testing'</span>, <span class="st">'death_hat4'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at PDP charts and comparing against those of model 1, we see much more complex relationship between the covariates and the log mortality rates.</p>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Gender'</span>, <span class="st">'death_hat4'</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Gender'</span>,<span class="st">'death_hat4'</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Smoker_Status'</span>,<span class="st">'death_hat4'</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Smoker_Status'</span>,<span class="st">'death_hat4'</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Attained_Age'</span>, <span class="st">'Preferred_Class'</span>,<span class="st">'death_hat4'</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>pdp2(train_df, <span class="st">'Duration'</span>, <span class="st">'Preferred_Class'</span>,<span class="st">'death_hat4'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare-model-1-model-2-and-model-4" class="level3">
<h3 class="anchored" data-anchor-id="compare-model-1-model-2-and-model-4">Compare Model 1, Model 2 and Model 4</h3>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'Err1'</span>] <span class="op">=</span> (train_df[<span class="st">'death_hat1'</span>] <span class="op">-</span> train_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> train_df[<span class="st">'death_hat1'</span>]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'Err2'</span>] <span class="op">=</span> (train_df[<span class="st">'death_hat2'</span>] <span class="op">-</span> train_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> train_df[<span class="st">'death_hat2'</span>]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'Err4'</span>] <span class="op">=</span> (train_df[<span class="st">'death_hat4'</span>] <span class="op">-</span> train_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> train_df[<span class="st">'death_hat4'</span>]</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> train_df.groupby(<span class="st">'Attained_Age'</span>)[<span class="st">'Err1'</span>, <span class="st">'Err2'</span>, <span class="st">'Err4'</span>, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err1'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err2'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err4'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Model 1'</span>, <span class="st">'Model 2'</span>, <span class="st">'Model 4'</span>])</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.ylim(0,1)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.xlim(30,85)</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Error'</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Training Error'</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">7</span>,<span class="dv">3</span>))</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Err1'</span>] <span class="op">=</span> (test_df[<span class="st">'death_hat1'</span>] <span class="op">-</span> test_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> test_df[<span class="st">'death_hat1'</span>]</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Err2'</span>] <span class="op">=</span> (test_df[<span class="st">'death_hat2'</span>] <span class="op">-</span> test_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> test_df[<span class="st">'death_hat2'</span>]</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Err4'</span>] <span class="op">=</span> (test_df[<span class="st">'death_hat4'</span>] <span class="op">-</span> test_df[<span class="st">'Number_Of_Deaths'</span>].astype(<span class="bu">float</span>)).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span> test_df[<span class="st">'death_hat4'</span>]</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> test_df.groupby(<span class="st">'Attained_Age'</span>)[<span class="st">'Err1'</span>, <span class="st">'Err2'</span>, <span class="st">'Err4'</span>, <span class="st">'Policies_Exposed'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err1'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err2'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x <span class="op">=</span> agg[<span class="st">'Attained_Age'</span>], y <span class="op">=</span> np.sqrt(agg[<span class="st">'Err4'</span>]<span class="op">/</span>agg[<span class="st">'Policies_Exposed'</span>]), ax <span class="op">=</span> ax)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Model 1'</span>, <span class="st">'Model 2'</span>, <span class="st">'Model 4'</span>])</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Error'</span>)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.ylim(0,1)</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.xlim(30,85)</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> plt.title(<span class="st">'Testing Error'</span>)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>res1.save(<span class="st">'mortality_model.pickle'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left"><em>Â© Copyright 2023 ValidMind Inc All Rights Reserved.</em></div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/validmind/documentation">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/company/validmind/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>