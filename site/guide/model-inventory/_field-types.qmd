<!-- Copyright © 2023-2026 ValidMind Inc. All rights reserved.
Refer to the LICENSE file in the root of this repository for details.
SPDX-License-Identifier: AGPL-3.0 AND ValidMind Commercial -->

:::: {.content-visible unless-format="revealjs"}

:::: {.content-visible when-format="html" when-meta="includes.inventory"}
Attachments
: Upload supporting files for your model.^[[Manage supporting documentation](/guide/model-inventory/edit-model-inventory-fields.qmd#manage-supporting-documentation)] Files must be less than 50 MB each in size.
::::

:::: {.content-visible when-format="html" when-meta="includes.artifacts"}
Attachments
: Upload supporting files for your artifact.^[[Manage supporting documentation](/guide/model-validation/add-manage-artifacts.qmd#manage-supporting-documentation)] Files must be less than 50 MB each in size.
::::

Calculation
: Define a `formula(params)` function that automatically calculates and returns a value based on the params dictionary, which includes selected custom field keys retrieved from your other inventory model fields.

:::: {.content-visible when-format="html" when-meta="includes.inventory"}
1. Select from the drop-down of **[available model fields]{.smallcaps}** to allow your formula access to the field's values.^[Fields are grouped by field type.]
2. Replace the demonstration formula with your own in the code box provided.^[**Stick to basic operations**.<br>Keep your code simple and avoid complex logic and imports.]
3. Click **Test Calculation {{< fa angle-down >}}** to open the testing area.
4. Enter sample values in the testing area then click **{{< fa play >}} Test Calculation** to validate your formula.
<br><br>

::: {.callout-button .pl4 .nt4}
::: {.callout collapse="true" appearance="minimal"}

### Example — Risk Tier Calculation

You have numeric model inventory fields of `materiality` and `complexity`, where a larger value indicates a lower risk.

##### Example formula

You want a calculated field that automatically returns a risk score based on `materiality` and `complexity`:

```python
    def formula(params):
        # High Risk: If materiality is high risk, return high risk regardless of complexity
        if params.materiality == "High Risk":
                return "High Risk"
        # Medium Risk: If materiality is low risk but complexity is high risk, return medium risk
        if params.materiality == "Low Risk" and params.complexity  == "High Risk":
                return "Medium Risk"
        # Low Risk: Both materiality and complexity are low risk
        return "Low Risk"
```

##### Example Calculation field configuration

Your calculated field is grouped under `Model Risk` inventory fields, and can only be manually overridden by that model's Model Validators:

![Adding a calculation type field that automatically calculates risk tier](calculation-field.png){fig-alt="A screenshot showing the screen for adding a calculation type field that automatically calculates risk tier" width=90% .screenshot}

:::
:::

::: {.callout-button .pl4 .nt4}
::: {.callout collapse="true" appearance="minimal"}

### Example — Date arithmetic and vm_today

Formulas can use date and time types for scheduling and countdowns. The following are available in your formula:

| Name | Description |
|------|-------------|
| `vm_today` | Today's date (updates each time the formula runs) |
| `date` | Python's `datetime.date` class |
| `datetime` | Python's `datetime.datetime` class |
| `timedelta` | Duration in days, seconds, or microseconds |
| `relativedelta` | Duration in months, years, etc. (from `dateutil`) |

**Next review date** — Add an interval to an approval date based on risk tier:

```python
def formula(params):
    if params.dmApprovedDate == "":
        return "N/A"
    approved_date = date.fromtimestamp(int(params.dmApprovedDate) / 1000)
    review_frequency = {
        "Tier 1": relativedelta(months=3),
        "Tier 2": relativedelta(months=6),
        "Tier 3": relativedelta(years=1),
    }
    frequency = review_frequency.get(params.dmRiskTier)
    if not frequency:
        return "N/A"
    next_review_date = approved_date + frequency
    return next_review_date.isoformat()
```

**Days remaining** — Use `vm_today` to show a countdown to the next review (formula re-evaluates so the countdown updates over time):

```python
def formula(params):
    if not params.nextReviewDate:
        return "N/A"
    next_review = date.fromisoformat(params.nextReviewDate)
    difference = next_review - vm_today
    return f"{difference.days} days remaining"
```

**Note:** Date fields are passed into formulas as millisecond timestamps; use `date.fromtimestamp(int(params.fieldName) / 1000)` to convert. Formula results are strings — use `.isoformat()` for date values.

:::
:::


::::

:::: {.content-visible when-format="html" when-meta="includes.artifacts"}
1. Select from the drop-down of **[available artifact fields]{.smallcaps}** and **[model fields available via]{.smallcaps} `params.model`** to allow your formula access to the field's values.^[Fields are grouped by field type.]
2. Replace the demonstration formula with your own in the code box provided.^[**Stick to basic operations**.<br>Keep your code simple and avoid complex logic and imports.]
4. Click **Test Calculation {{< fa angle-down >}}** to open the testing area.
5. Enter in sample values in the testing area then click **{{< fa play >}} Test Calculation** to validate your formula.
<br><br>

::: {.callout-button .pl4 .nt4}
::: {.callout collapse="true" appearance="minimal"}

### Use artifact types in your formulas to create dynamic calculations.

Use simple dot notation to include [artifact types](/guide/model-validation/manage-artifact-types.qmd){target="_blank"}:

- `finding_type.tag` — Technical tag: `VALIDATION_ISSUE`
- `finding_type.name` — Human-readable name: `Validation Issue`

##### Example use cases

- Calculate different risk scores based on artifact type.
- Generate dynamic titles and descriptions.
- Set different due dates or priorities by artifact category.
- Create type-specific business logic in formulas.

::: {.panel-tabset}

#### Severity calculation

```python
# Calculate different severity scores based on artifact type

if finding_type.tag == "VALIDATION_ISSUE":
    return severity_score * 2.5
elif finding_type.tag == "POLICY_EXCEPTION":
    return severity_score * 1.0
else:
    return severity_score * 1.8
```

#### Due date calculation

```python
# Dynamically calculate due dates based on artifact type

base_days = 30
if finding_type.tag == "VALIDATION_ISSUE":
    urgency_multiplier = 0.5  # 15 days
elif finding_type.tag == "MODEL_LIMITATION":
    urgency_multiplier = 2.0  # 60 days
else:
    urgency_multiplier = 1.0  # 30 days

return base_days * urgency_multiplier
```

#### Custom fields & parent model data

```python
# Combine artifact types with custom fields and parent model data

risk_factor = custom_field_risk_score or 1.0
model_criticality = params.model.get("criticality_level", "medium")

if finding_type.tag == "VALIDATION_ISSUE" and model_criticality == "high":
    return risk_factor * 3.0
else:
    return risk_factor * 1.5
```

:::

:::
:::

::::

Checkbox
: A `true`/`false` value set by a toggle.

Date
: - Date value in `yyyy-mm-dd` format. 
- Selection is in the current user's timezone; other users viewing this field will see the value automatically in their timezone. 
- Set the [date format]{.smallcaps} for date fields under your profile.^[[Manage your profile](/guide/configuration/manage-your-profile.qmd#localization)]

Date Time
: - Date value in `yyyy-mm-dd, 24hr` format.
- Selection is in the current user's timezone; other users viewing this field will see the value automatically in their timezone. 
- Set the [date format]{.smallcaps} for date time fields under your profile.^[[Manage your profile](/guide/configuration/manage-your-profile.qmd#localization)]

Email
: Text value in valid email (`user@domain.com`) format.

Long Text
: Toggle **Enable rich text formatting** to create a template using the rich text editor.

Multiple Select
: Click **{{< fa plus >}} Add Option** to define a list of options. 

Number
: Text value in valid number format. Number display (comma, fullstop, etc.) is determined by your browser's locale. Select a **[number type]{.smallcaps}**:

- **Simple** — Define the [decimal places]{.smallcaps} that the number should be displayed up to and any [large number abbreviation]{.smallcaps}s.
- **Currency** — Define the [currency]{.smallcaps} you would like the field to display in, as well as the [decimal places]{.smallcaps} that the number should be displayed up to and any [large number abbreviation]{.smallcaps}s.

:::: {.flex .flex-wrap .justify-around}

::: {.w-50-ns}

![Simple number field type](/guide/model-inventory/number-simple.png){fig-alt="A screenshot showing a simple number field type" .screenshot group="number"} 

:::

::: {.w-40-ns}

![Currency number field type](/guide/model-inventory/number-currency.png){fig-alt="A screenshot showing a currency number field type" .screenshot group="number"}

:::

::::

Single Line Text
: Simple text value.

Single Select
: Click **{{< fa plus >}} Add Option** to define a list of options.

URL
: Text value in valid URL format.

User
: 
- Select list pre-populated with users from your {{< fa book-open >}} User Directory.^[[Manage users](/guide/configuration/manage-users.qmd)]
- Toggle [allow linking to multiple records]{.smallcaps} on to allow multi-selection of users.

::::


:::: {.content-hidden unless-format="revealjs"}
Attachments
: Upload supporting files for your [model](/guide/model-inventory/edit-model-inventory-fields.qmd#manage-supporting-documentation){target="_blank"} or [artifact](/guide/model-validation/add-manage-artifacts.qmd#manage-supporting-documentation){target="_blank"}. Files must be less than 50 MB each in size.

Calculation
: Define a `formula(params)` function that automatically calculates and returns a value based on the params dictionary, which includes selected custom field keys retrieved from your other inventory model fields.

    1. Select from the drop-down of **[available model fields]{.smallcaps}** (model inventory fields), or **[available artifact fields]{.smallcaps}** and **[model fields available via]{.smallcaps} `params.model`** (artifact fields) to allow your formula access to the field's values.
    2. Replace the demonstration formula with your own in the code box provided.
    4. Click **Test Calculation {{< fa angle-down >}}** to open the testing area.
    5. Enter in sample values in the testing area then click **{{< fa play >}} Test Calculation** to validate your formula.

Checkbox
: A `true`/`false` value set by a toggle.

Date
: - Date value in `yyyy-mm-dd` format. 
- Selection is in the current user's timezone; other users viewing this field will see the value automatically in their timezone. 

Date Time
: - Date value in `yyyy-mm-dd, 24hr` format.
- Selection is in the current user's timezone; other users viewing this field will see the value automatically in their timezone. 

Email
: Text value in valid email (`user@domain.com`) format.

Long Text
: Toggle **Enable rich text formatting** to create a template using the rich text editor.

Multiple Select
: Click **{{< fa plus >}} Add Option** to define a list of options.

Number
: Text value in valid number format. Number display (comma, fullstop, etc.) is determined by your browser's locale. Select a **[number type]{.smallcaps}**:

    - **Simple** — Define the [decimal places]{.smallcaps} that the number should be displayed up to and any [large number abbreviation]{.smallcaps}s.
    - **Currency** — Define the [currency]{.smallcaps} you would like the field to display in, as well as the [decimal places]{.smallcaps} that the number should be displayed up to and any [large number abbreviation]{.smallcaps}s.

Single Line Text
: Simple text value.

Single Select
: Click **{{< fa plus >}} Add Option** to define a list of options.

URL
: Text value in valid URL format.

User
: 
- Select list pre-populated with users from your [{{< fa book-open >}} User Directory](/guide/configuration/manage-users.qmd){target="_blank"}.
- Toggle [allow linking to multiple records]{.smallcaps} on to allow multi-selection of users.

::::
