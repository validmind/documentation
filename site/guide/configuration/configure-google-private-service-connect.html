<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-11-25">

<title>Configure Google Cloud Private Service Connect</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="configure-google-private-service-connect_files/libs/clipboard/clipboard.min.js"></script>
<script src="configure-google-private-service-connect_files/libs/quarto-html/quarto.js"></script>
<script src="configure-google-private-service-connect_files/libs/quarto-html/popper.min.js"></script>
<script src="configure-google-private-service-connect_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="configure-google-private-service-connect_files/libs/quarto-html/anchor.min.js"></script>
<link href="configure-google-private-service-connect_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="configure-google-private-service-connect_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="configure-google-private-service-connect_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="configure-google-private-service-connect_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="configure-google-private-service-connect_files/libs/bootstrap/bootstrap-abba8c2a7bf59ad0afd2a7907c827254.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="configure-google-private-service-connect_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="configure-google-private-service-connect_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="configure-google-private-service-connect_files/libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="configure-google-private-service-connect_files/libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="configure-google-private-service-connect_files/libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Configure Google Cloud Private Service Connect</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 25, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>To keep your network traffic private and minimize its attack surface, configure Private Service Connect to establish a private connection between ValidMind and your company network.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="google-cloud-private-service-connect.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Google Private Service Connect establishing a private connection to ValidMind"><img src="google-cloud-private-service-connect.png" class="img-fluid figure-img" alt="A graphic showing Google Private Service Connect establishing a private connection to ValidMind"></a></p>
<figcaption>Google Private Service Connect establishing a private connection to ValidMind</figcaption>
</figure>
</div>
<p>Private Service Connect is a networking service that allows secure and private communication between Google Virtual Private Cloud (VPC) resources and services hosted in other VPCs or Google partner services, such as ValidMind. By creating private endpoints within your VPC, Private Service Connect allows you to connect to services over the Google network without needing to expose your network traffic to the public internet.</p>
<div class="callout callout-style-default callout-important callout-titled" title="The responsibility of setting up endpoints for Private Service Connect falls to your IT department, such as the cloud engineering, infrastructure, or security teams.">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The responsibility of setting up endpoints for Private Service Connect falls to your IT department, such as the cloud engineering, infrastructure, or security teams.
</div>
</div>
<div class="callout-body-container callout-body">
<p><br> To learn more about Private Service Connect, check the official Google documentation.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</div>
</div>
<section id="prerequisites" class="level2 attn">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>You must have access to the Google Cloud Console for your company and the necessary expertise to set up, configure, and maintain Google Cloud services.</p>
<p>These steps assume that you already have established connectivity between your own company network and Google VPC and know which company VPC you want to connect to.</p>
<section id="vpc-service-information" class="level3">
<h3 class="anchored" data-anchor-id="vpc-service-information">VPC service information</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Name</th>
<th>Provider</th>
<th>Region</th>
<th>Service name</th>
<th>Private DNS name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>US3</td>
<td>GCP</td>
<td><code>us-west1</code></td>
<td>Email <a href="mailto:support@validmind.com" class="email">support@validmind.com</a></td>
<td>Email <a href="mailto:support@validmind.com" class="email">support@validmind.com</a></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="configure-your-google-cloud-platform-project" class="level2">
<h2 class="anchored" data-anchor-id="configure-your-google-cloud-platform-project">Configure your Google Cloud Platform project</h2>
<p>Enable the APIs for cloud DNS and networking to get ready for the next steps:</p>
<ol type="1">
<li><p>Log into the <a href="https://console.cloud.google.com/">Google Cloud Console</a>.</p></li>
<li><p>From the <strong>Select a project</strong> drop-down at the top of the console, select the project where you want to enable the Google APIs.</p></li>
<li><p>In the navigation menu on the left, click <strong>APIs &amp; Services</strong> and then <strong>Library</strong>.</p></li>
<li><p>In the API Library, search for “Cloud DNS API” and click the result to open the API page.</p></li>
<li><p>On the API page for Cloud DNS, click <strong>Enable</strong> to activate the API for your project.</p></li>
<li><p>Repeat these steps for the Networking API:</p>
<ol type="a">
<li>Click <strong>Library</strong> in the left navigation to return to the API Library.</li>
<li>Search for “Google Compute Engine API” which includes networking services.</li>
<li>Click on the search result and click <strong>Enable</strong> to activate the API.</li>
</ol></li>
</ol>
<p>After these steps, both the Cloud DNS and the Google Compute Engine API should be enabled for your project, allowing you to manage DNS configurations and networking resources.</p>
</section>
<section id="request-access-from" class="level2">
<h2 class="anchored" data-anchor-id="request-access-from">Request access from ValidMind</h2>
<p>Contact ValidMind at <a href="mailto:support@validmind.ai?subject=VPC%20Endpoint%20Connection%20Request">support@validmind.ai</a> to get your new VPC endpoint connection request accepted. Include the following information:</p>
<ul>
<li>The project name</li>
<li>The project ID</li>
</ul>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Please provide this information to ValidMind <strong>at least 24 hours</strong> before attempting to connect, so that we can add your project to the allowlist.</p>
</div>
</div>
</div>
</section>
<section id="prepare-your-network-for-connection" class="level2">
<h2 class="anchored" data-anchor-id="prepare-your-network-for-connection">Prepare your network for connection</h2>
<p>Create a private subnet in a supported GCP region that can be used to expose ValidMind services:</p>
<ol type="1">
<li><p>In Google Cloud Console, create the subnet:</p>
<ol type="a">
<li>On the VPC networks page, click <strong>Create VPC network</strong>.</li>
<li>Name your network.</li>
<li>Configure the IP address range to ensure it includes at least a <code>/28</code> of usable private IP address space.</li>
<li>Click <strong>Create</strong>.</li>
</ol></li>
<li><p>Optional: Enable Private Google Access to provide access to Google APIs and services.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p></li>
<li><p>Provision two IP addresses in this subnet for later use:</p>
<ol type="a">
<li>On the VPC networks page, select your subnet.</li>
<li>Note the available IP address range.</li>
<li>Reserve two IP addresses within this range for future use.</li>
</ol></li>
</ol>
</section>
<section id="create-an-endpoint-to-connect-to" class="level2">
<h2 class="anchored" data-anchor-id="create-an-endpoint-to-connect-to">Create an endpoint to connect to ValidMind</h2>
<p>Create a Private Service Connect endpoint for accessing ValidMind services securely and privately, with service discovery managed via Google Cloud’s Service Directory.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="gcp-add-validmind-endpoint-panel.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Creating an endpoint in the Google Cloud Console"><img src="gcp-add-validmind-endpoint-panel.png" class="screenshot img-fluid figure-img" style="width:90.0%" alt="Screenshot of an endpoint being created with the options specified in the steps"></a></p>
<figcaption>Creating an endpoint in the Google Cloud Console</figcaption>
</figure>
</div>
<section id="steps" class="level3">
<h3 class="anchored" data-anchor-id="steps">Steps</h3>
<ol type="1">
<li><p>In Google Cloud Console, open <strong>Network services</strong> and click <strong>Private Service Connect</strong>.</p></li>
<li><p>Create the endpoint:</p>
<ol type="a">
<li><p>Click <strong>Create Connection Endpoint</strong>.</p></li>
<li><p>Check <strong>Published service</strong> for the target.</p></li>
<li><p>For <strong>Endpoint name</strong>, enter <code>private</code>.</p></li>
<li><p>For <strong>Target service</strong>, enter:</p>
<p><code>projects/validmind-us3-prod/regions/us-central1/serviceAttachments/private</code>.</p></li>
<li><p>For <strong>IP address</strong>, enter <code>validmind</code>.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Make sure this name resolves to an appropriate IP in your network settings or is preconfigured in your DNS.</p>
</div>
</div>
</div></li>
<li><p>Enable Service Directory for this endpoint to provide DNS resolution and enable service discovery.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Choose the same region as your endpoint to ensure low latency and local management of services.</p>
</div>
</div>
</div></li>
<li><p>For <strong>Namespace</strong>, enter <code>validmind</code>.</p></li>
<li><p>Click <strong>Add Endpoint</strong>.</p></li>
</ol></li>
</ol>
<p>After the endpoint is active, test that the service is reachable through the private connection and that DNS requests resolve as expected.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="gcp-add-validmind-endpoint.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Active private endpoint in the Google Cloud Console"><img src="gcp-add-validmind-endpoint.png" class="screenshot img-fluid figure-img" style="width:90.0%" alt="Active endpoint being shown in the Google Cloud Console"></a></p>
<figcaption>Active <code>private</code> endpoint in the Google Cloud Console</figcaption>
</figure>
</div>
</section>
</section>
<section id="create-an-endpoint-to-connect-to-the-authentication-service" class="level2">
<h2 class="anchored" data-anchor-id="create-an-endpoint-to-connect-to-the-authentication-service">Create an endpoint to connect to the ValidMind authentication service</h2>
<p>Repeat the steps to create an endpoint to connect to ValidMind<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> to add another endpoint for the ValidMind authentication service.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="gcp-add-auth-endpoint-panel.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Creating an endpoint in the Google Cloud Console"><img src="gcp-add-auth-endpoint-panel.png" class="screenshot img-fluid figure-img" style="width:90.0%" alt="Screenshot of an endpoint being created with the options specified in the steps"></a></p>
<figcaption>Creating an endpoint in the Google Cloud Console</figcaption>
</figure>
</div>
<section id="steps-1" class="level3">
<h3 class="anchored" data-anchor-id="steps-1">Steps</h3>
<ol type="1">
<li><p>Check <strong>Published service</strong> for the target.</p></li>
<li><p>For <strong>Target service</strong>, enter:</p>
<p><code>projects/validmind-us3-prod/regions/us-central1/serviceAttachments/auth</code>.</p></li>
<li><p>For <strong>Endpoint name</strong>, enter <code>auth</code>.</p></li>
<li><p>Enable Service Directory for this endpoint</p></li>
<li><p>For <strong>Namespace</strong>, enter <code>validmind</code>.</p></li>
</ol>
<p>After the endpoint is active, test that the service is reachable through the private connection and that DNS requests resolve as expected.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="gcp-add-auth-endpoint.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Active auth endpoint in the Google Cloud Console"><img src="gcp-add-auth-endpoint.png" class="screenshot img-fluid figure-img" style="width:90.0%" alt="Active endpoint being shown in the Google Cloud Console"></a></p>
<figcaption>Active <code>auth</code> endpoint in the Google Cloud Console</figcaption>
</figure>
</div>
</section>
</section>
<section id="test-connectivity" class="level2">
<h2 class="anchored" data-anchor-id="test-connectivity">Test connectivity</h2>
<p>As a final step, test that everything everything is set up correctly and that you can reach the ValidMind services:</p>
<ol type="1">
<li><p>Under Network Services &gt; Cloud DNS, verify that DNS and service discovery are functioning as expected.</p></li>
<li><p>Test your connection to the following hosts:</p></li>
</ol>
<ul>
<li><strong>ValidMind Platform</strong> — <a href="https://private.us3-prod.validmind.ai">https://private.us3-prod.validmind.ai</a></li>
<li><strong>ValidMind authentication service</strong> — <a href="https://auth.private.validmind.ai">https://auth.private.validmind.ai</a></li>
</ul>
<!-- FOOTNOTES -->
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><strong>Google:</strong> <a href="https://cloud.google.com/vpc/docs/private-service-connect">Private Service Connect</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><strong>Google:</strong> <a href="https://cloud.google.com/vpc/docs/private-google-access">Private Google Access</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><a href="#create-an-endpoint-to-connect-to-validmind">Create an endpoint to connect to ValidMind</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>